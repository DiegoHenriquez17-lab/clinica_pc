{% extends 'base.html' %}

{% block title %}Recepción de Equipos - Clínica PC{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold text-gray-800">Recepción de Equipos</h2>
    <p class="text-gray-600 mt-1">Registrar nuevos dispositivos</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Reception Form -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Ingreso</h3>
            <form method="post" enctype="multipart/form-data" class="space-y-4" id="cliente-form" novalidate>
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Cliente *</label>
                        <input type="text" name="nombre_cliente" id="nombre_cliente" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <p class="text-red-600 text-xs mt-1 hidden" id="error-nombre_cliente"></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">RUT Cliente</label>
                        <input type="text" name="rut_cliente" id="rut_cliente" placeholder="12345678-9" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-red-600 text-xs mt-1 hidden" id="error-rut_cliente"></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Teléfono *</label>
                        <input type="tel" name="telefono" id="telefono" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <p class="text-red-600 text-xs mt-1 hidden" id="error-telefono"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ciudad</label>
                        <input type="text" name="ciudad" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" name="correo" id="correo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <p class="text-red-600 text-xs mt-1 hidden" id="error-correo"></p>
                </div>

                <!-- Campo de imagen del carnet -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-id-card mr-1"></i>Imagen del Carnet
                        <span class="text-xs text-gray-500">(por seguridad)</span>
                    </label>
                    <input type="file" name="imagen_carnet" accept="image/*" id="imagen_carnet" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p class="text-xs text-gray-500 mt-1">Formatos permitidos: JPG, PNG, GIF (máx. 5MB)</p>
                    <img id="preview-carnet" class="hidden mt-2 max-w-xs max-h-32 border rounded object-contain" alt="Vista previa del carnet">
                    <button type="button" id="camera-btn" class="mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        <i class="fas fa-camera mr-2"></i>Tomar Foto con Cámara
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Dispositivo *</label>
                        <select name="tipo_equipo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            <option value="">Seleccione...</option>
                            <option value="Laptop">Laptop</option>
                            <option value="PC Escritorio">PC Escritorio</option>
                            <option value="All-in-One">All-in-One</option>
                            <option value="Tablet">Tablet</option>
                            <option value="Servidor">Servidor</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Marca</label>
                        <input type="text" name="marca" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Modelo</label>
                    <input type="text" name="modelo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Serie</label>
                    <input type="text" name="serial" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Problema Reportado *</label>
                    <textarea name="problema" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Relato del Cliente * <span class="text-xs text-gray-500">(exacto, sin edición)</span></label>
                    <textarea name="relato_cliente" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Escriba aquí exactamente lo que relata el cliente..." required></textarea>
                </div>



                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Accesorios Incluidos</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="accesorios" value="Cargador" class="mr-2"> Cargador
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="accesorios" value="Mouse" class="mr-2"> Mouse
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="accesorios" value="Teclado" class="mr-2"> Teclado
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="accesorios" value="Bolso" class="mr-2"> Bolso
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observaciones del Equipo</label>
                    <textarea name="observaciones_adicionales" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Observaciones específicas sobre el equipo..."></textarea>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200">
                    <i class="fas fa-plus-circle mr-2"></i>Registrar Equipo
                </button>
            </form>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="space-y-6">
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Ingresos Hoy</h3>
            <div class="text-center">
                <p class="text-5xl font-bold text-blue-600">{{ ingresos_hoy }}</p>
                <p class="text-gray-600 mt-2">equipos recibidos</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Últimos Ingresos</h3>
            <div class="space-y-3">
                {% for equipo in ultimos_ingresos %}
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="font-medium text-sm">{{ equipo.cliente.nombre }}</p>
                        <p class="text-xs text-gray-600">{{ equipo.tipo_equipo }}</p>
                        <p class="text-xs text-gray-500">{{ equipo.created_at|date:"H:i" }}</p>
                    </div>
                {% empty %}
                    <p class="text-gray-500 text-sm text-center py-4">No hay ingresos recientes</p>
                {% endfor %}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-users mr-2"></i>Clientes Recientes
            </h3>
            <div class="space-y-3">
                {% for cliente in clientes_recientes %}
                    <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <p class="font-medium text-sm">{{ cliente.nombre }}</p>
                                {% if cliente.rut %}
                                <p class="text-xs text-gray-600">{{ cliente.rut }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500">{{ cliente.created_at|date:"d/m H:i" }}</p>
                            </div>
                            <div class="flex space-x-1">
                                <a href="{% url 'recepcion:ver_cliente' cliente.id %}" 
                                   class="text-blue-600 hover:text-blue-800 p-1 rounded" 
                                   title="Ver información">
                                    <i class="fas fa-eye text-xs"></i>
                                </a>
                                {% if cliente.imagen_carnet %}
                                <div class="text-green-600 p-1" title="Tiene carnet">
                                    <i class="fas fa-id-card text-xs"></i>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-gray-500 text-sm text-center py-4">No hay clientes registrados</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Camera Modal -->
<div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
        <h3 class="text-lg font-bold mb-4">Tomar Foto del Carnet</h3>
        <video id="camera-video" autoplay class="w-full border rounded"></video>
        <canvas id="camera-canvas" class="hidden"></canvas>
        <div class="flex justify-between mt-4">
            <button id="capture-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Capturar Foto</button>
            <button id="close-modal" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">Cancelar</button>
        </div>
    </div>
</div>

<script>
document.getElementById('camera-btn').addEventListener('click', function() {
    const modal = document.getElementById('camera-modal');
    modal.classList.remove('hidden');
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            const video = document.getElementById('camera-video');
            video.srcObject = stream;
        })
        .catch(function(err) {
            alert('Error al acceder a la cámara: ' + err.message);
        });
});

document.getElementById('capture-btn').addEventListener('click', function() {
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    const context = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    canvas.toBlob(function(blob) {
        const file = new File([blob], 'carnet.jpg', { type: 'image/jpeg' });
        const input = document.getElementById('imagen_carnet');
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
        // Trigger change event to show preview
        input.dispatchEvent(new Event('change'));
        // Close modal
        document.getElementById('camera-modal').classList.add('hidden');
        // Stop stream
        video.srcObject.getTracks().forEach(track => track.stop());
    }, 'image/jpeg');
});

document.getElementById('close-modal').addEventListener('click', function() {
    document.getElementById('camera-modal').classList.add('hidden');
    const video = document.getElementById('camera-video');
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
});

// Preview de imagen del carnet
document.getElementById('imagen_carnet').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('preview-carnet');

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    } else {
        preview.classList.add('hidden');
    }
});

// Validaciones en tiempo real
const form = document.getElementById('cliente-form');
const fields = {
    nombre_cliente: { required: true, minLength: 3 },
    rut_cliente: { required: false, validate: validateRUT },
    telefono: { required: true, validate: validatePhone },
    correo: { required: false, validate: validateEmail }
};

function showError(fieldId, message) {
    const errorElement = document.getElementById('error-' + fieldId);
    errorElement.textContent = message;
    errorElement.classList.remove('hidden');
    document.getElementById(fieldId).classList.add('border-red-500');
}

function hideError(fieldId) {
    const errorElement = document.getElementById('error-' + fieldId);
    errorElement.classList.add('hidden');
    document.getElementById(fieldId).classList.remove('border-red-500');
}

function validateRUT(rut) {
    if (!rut) return true; // Optional field
    rut = rut.replace(/\./g, '').replace(/-/g, '');
    if (rut.length < 8 || rut.length > 9) return false;
    const body = rut.slice(0, -1);
    const dv = rut.slice(-1).toUpperCase();
    let sum = 0;
    let multiplier = 2;
    for (let i = body.length - 1; i >= 0; i--) {
        sum += parseInt(body[i]) * multiplier;
        multiplier = multiplier === 7 ? 2 : multiplier + 1;
    }
    const expectedDv = 11 - (sum % 11);
    const calculatedDv = expectedDv === 11 ? '0' : expectedDv === 10 ? 'K' : expectedDv.toString();
    return dv === calculatedDv;
}

function validatePhone(phone) {
    const cleanPhone = phone.replace(/\s/g, '');
    return /^\d{9}$/.test(cleanPhone) && cleanPhone.startsWith('9');
}

function validateEmail(email) {
    if (!email) return true; // Optional field
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function validateField(fieldId) {
    const field = document.getElementById(fieldId);
    const value = field.value.trim();
    const config = fields[fieldId];

    if (config.required && !value) {
        showError(fieldId, 'Este campo es obligatorio');
        return false;
    }

    if (config.minLength && value.length < config.minLength) {
        showError(fieldId, `Debe tener al menos ${config.minLength} caracteres`);
        return false;
    }

    if (config.validate && !config.validate(value)) {
        let message = '';
        if (fieldId === 'rut_cliente') message = 'RUT inválido';
        else if (fieldId === 'telefono') message = 'Teléfono debe ser 9 dígitos empezando con 9';
        else if (fieldId === 'correo') message = 'Email inválido';
        showError(fieldId, message);
        return false;
    }

    hideError(fieldId);
    return true;
}

// Event listeners
Object.keys(fields).forEach(fieldId => {
    const field = document.getElementById(fieldId);
    field.addEventListener('input', () => validateField(fieldId));
    field.addEventListener('blur', () => validateField(fieldId));
});

// Form submit validation
form.addEventListener('submit', function(e) {
    let isValid = true;
    Object.keys(fields).forEach(fieldId => {
        if (!validateField(fieldId)) {
            isValid = false;
        }
    });
    if (!isValid) {
        e.preventDefault();
        alert('Por favor, corrige los errores en el formulario antes de enviar.');
    }
});
</script>

{% endblock %}
