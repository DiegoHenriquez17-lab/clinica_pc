{% extends 'base.html' %}

{% block title %}Despacho y Entrega - Clínica PC{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold text-gray-800">Despacho y Entrega</h2>
    <p class="text-gray-600 mt-1">Gestionar entregas de equipos</p>
</div>

<!-- Estadísticas rápidas -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-green-500">
        <div class="flex items-center">
            <div class="bg-green-100 rounded-full p-3 mr-4">
                <i class="fas fa-box text-green-600"></i>
            </div>
            <div>
                <p class="text-gray-600 text-sm">Listos para Entrega</p>
                <p class="text-2xl font-bold text-gray-800">{{ total_listos }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-blue-500">
        <div class="flex items-center">
            <div class="bg-blue-100 rounded-full p-3 mr-4">
                <i class="fas fa-shipping-fast text-blue-600"></i>
            </div>
            <div>
                <p class="text-gray-600 text-sm">Entregados Hoy</p>
                <p class="text-2xl font-bold text-gray-800">{{ entregados_hoy }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-purple-500">
        <div class="flex items-center">
            <div class="bg-purple-100 rounded-full p-3 mr-4">
                <i class="fas fa-filter text-purple-600"></i>
            </div>
            <div>
                <p class="text-gray-600 text-sm">Equipos Mostrados</p>
                <p class="text-2xl font-bold text-gray-800">{{ equipos_listos|length }}</p>
            </div>
        </div>
    </div>
</div>



<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Panel izquierdo para envío urgente -->
    <div id="sendBackPanel" class="hidden">
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Enviar de Vuelta con Prioridad Urgente</h3>
            <form id="sendBackForm" method="post" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" id="sendBackEquipoId" name="equipo_id">
                <input type="hidden" id="sendBackAction" name="action">

                <div id="sendBackEquipoInfo" class="p-4 bg-gray-50 rounded-lg mb-4">
                    <!-- Info del equipo se carga dinámicamente -->
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observación *</label>
                    <textarea name="observacion" id="sendBackObservacion" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Explique por qué se devuelve el equipo..." required></textarea>
                    <p class="text-xs text-gray-500 mt-1">Esta observación será registrada en el historial del equipo</p>
                </div>

                <button type="submit" id="sendBackButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition duration-200">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Enviar
                </button>

                <button type="button" onclick="cancelarEnvio()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg transition duration-200">
                    Cancelar
                </button>
            </form>
        </div>
    </div>

    <!-- Listado de equipos -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800">
                        {% if filtros.estado_actual == 'despacho' %}
                            Equipos Listos para Entrega
                        {% elif filtros.estado_actual == 'entregado' %}
                            Equipos Entregados
                        {% elif filtros.estado_actual == 'todos' %}
                            Todos los Equipos
                        {% else %}
                            Equipos Filtrados
                        {% endif %}
                    </h3>
                    <form method="GET" class="flex space-x-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                            <select name="estado" onchange="this.form.submit()" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                {% for valor, etiqueta in filtros.estados_disponibles %}
                                    <option value="{{ valor }}" {% if filtros.estado_actual == valor %}selected{% endif %}>
                                        {{ etiqueta }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ordenar por</label>
                            <select name="ordenar" onchange="this.form.submit()" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                {% for valor, etiqueta in filtros.ordenar_opciones %}
                                    <option value="{{ valor }}" {% if filtros.ordenar_actual == valor %}selected{% endif %}>
                                        {{ etiqueta }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
            </div>
            <div class="divide-y divide-gray-200">
                {% for equipo in equipos_listos %}
                    <div class="p-6 hover:bg-gray-50 cursor-pointer" onclick="seleccionarEquipo({{ equipo.id }}, '{{ equipo.cliente.nombre }}', '{{ equipo.tipo_equipo }}', '{{ equipo.cliente.telefono }}', '{{ equipo.diagnostico.diagnostico|escapejs }}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        #{{ equipo.id }}
                                    </span>
                                    <h4 class="text-lg font-semibold text-gray-900">{{ equipo.cliente.nombre }}</h4>
                                    {% if equipo.estado == 'entregado' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            ENTREGADO
                                        </span>
                                    {% endif %}
                                </div>
                                <p class="text-sm text-gray-600 mt-1">{{ equipo.tipo_equipo }}</p>
                                {% if equipo.marca %}
                                    <p class="text-sm text-gray-500">{{ equipo.marca }} {{ equipo.modelo }}</p>
                                {% endif %}
                                {% if equipo.diagnostico %}
                                    <p class="text-sm text-gray-700 mt-2"><strong>Trabajo realizado:</strong> {{ equipo.diagnostico.diagnostico|truncatewords:15 }}</p>
                                    {% if equipo.diagnostico.reparacion_hardware and equipo.diagnostico.reparacion_hardware.costo_final %}
                                        <p class="text-sm text-gray-600 mt-1"><strong>Costo:</strong> ${{ equipo.diagnostico.reparacion_hardware.costo_final }}</p>
                                    {% elif equipo.diagnostico.reparacion_software and equipo.diagnostico.reparacion_software.costo_final %}
                                        <p class="text-sm text-gray-600 mt-1"><strong>Costo:</strong> ${{ equipo.diagnostico.reparacion_software.costo_final }}</p>
                                    {% endif %}
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-2">Listo desde: {{ equipo.updated_at|date:"d/m/Y H:i" }}</p>
                            </div>
                            <div class="flex flex-col space-y-2 ml-4">
                                <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
                                    <i class="fas fa-shipping-fast mr-2"></i>Entregar
                                </button>
                                <div class="flex space-x-2">
                                    <button type="button" onclick="mostrarFormularioEnvio({{ equipo.id }}, 'hardware')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-xs font-medium transition duration-200">
                                        <i class="fas fa-microchip mr-1"></i>Hardware Urgente
                                    </button>
                                    <button type="button" onclick="mostrarFormularioEnvio({{ equipo.id }}, 'software')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-xs font-medium transition duration-200">
                                        <i class="fas fa-code mr-1"></i>Software Urgente
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="px-6 py-8 text-center text-gray-500">
                        <i class="fas fa-shipping-fast text-4xl mb-2"></i>
                        <p>No hay equipos listos para entrega</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div>
        <div id="dispatchFormContainer" class="bg-white rounded-xl shadow-md p-6 hidden">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Registrar Entrega</h3>
            <form method="post" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" id="equipoId" name="equipo_id">
                
                <div id="equipoInfo" class="p-4 bg-gray-50 rounded-lg mb-4">
                    <!-- Info del equipo se carga dinámicamente -->
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Recibido Por *</label>
                    <input type="text" name="recibido_por" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">DNI/Documento *</label>
                    <input type="text" name="documento_receptor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observaciones de Entrega</label>
                    <textarea name="observaciones_entrega" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>

                <div>
                    <label class="flex items-center">
                        <input type="checkbox" name="cliente_satisfecho" value="1" checked class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Cliente satisfecho con el servicio</span>
                    </label>
                </div>

                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-200">
                    <i class="fas fa-check-circle mr-2"></i>Confirmar Entrega
                </button>
                
                <button type="button" onclick="cancelarEntrega()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg transition duration-200">
                    Cancelar
                </button>
            </form>
        </div>

        <div id="dispatchPlaceholder" class="bg-white rounded-xl shadow-md p-6">
            <div class="text-center text-gray-500">
                <i class="fas fa-hand-pointer text-4xl mb-3"></i>
                <p>Seleccione un equipo para despachar</p>
            </div>
        </div>
    </div>
</div>

<script>
function seleccionarEquipo(id, cliente, tipo, telefono, diagnostico) {
    document.getElementById('dispatchFormContainer').classList.remove('hidden');
    document.getElementById('dispatchPlaceholder').classList.add('hidden');

    document.getElementById('equipoId').value = id;
    document.getElementById('equipoInfo').innerHTML = `
        <h4 class="font-semibold text-gray-900">#${id} - ${cliente}</h4>
        <p class="text-sm text-gray-600">${tipo}</p>
        <p class="text-sm text-gray-600 mt-1"><strong>Teléfono:</strong> ${telefono}</p>
        <p class="text-sm text-gray-700 mt-2"><strong>Diagnóstico:</strong> ${diagnostico}</p>
    `;

    // Pre-llenar el campo "Recibido Por" con el nombre del cliente
    document.querySelector('input[name="recibido_por"]').value = cliente;
}

function cancelarEntrega() {
    document.getElementById('dispatchFormContainer').classList.add('hidden');
    document.getElementById('dispatchPlaceholder').classList.remove('hidden');
    document.querySelector('form').reset();
}

function mostrarFormularioEnvio(equipoId, action) {
    // Ocultar otros paneles si están visibles
    document.getElementById('dispatchFormContainer').classList.add('hidden');
    document.getElementById('dispatchPlaceholder').classList.add('hidden');

    // Mostrar el panel de envío
    document.getElementById('sendBackPanel').classList.remove('hidden');

    // Configurar el formulario
    document.getElementById('sendBackEquipoId').value = equipoId;
    document.getElementById('sendBackAction').value = action;

    // Cambiar el texto del botón según la acción
    const button = document.getElementById('sendBackButton');
    if (action === 'hardware') {
        button.innerHTML = '<i class="fas fa-microchip mr-2"></i>Enviar a Hardware (Urgente)';
        button.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition duration-200';
    } else {
        button.innerHTML = '<i class="fas fa-code mr-2"></i>Enviar a Software (Urgente)';
        button.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200';
    }

    // Configurar la acción del formulario
    const form = document.getElementById('sendBackForm');
    if (action === 'hardware') {
        form.action = '{% url "entrega:send_back_to_hardware" 0 %}'.replace('0', equipoId);
    } else {
        form.action = '{% url "entrega:send_back_to_software" 0 %}'.replace('0', equipoId);
    }

    // Limpiar el campo de observación
    document.getElementById('sendBackObservacion').value = '';

    // Cargar información del equipo (puedes obtener esto de los datos disponibles)
    // Por simplicidad, mostramos un mensaje genérico
    document.getElementById('sendBackEquipoInfo').innerHTML = `
        <h4 class="font-semibold text-gray-900">Equipo #${equipoId}</h4>
        <p class="text-sm text-gray-600">Enviando a ${action === 'hardware' ? 'Hardware' : 'Software'} con prioridad urgente</p>
    `;
}

function cancelarEnvio() {
    document.getElementById('sendBackPanel').classList.add('hidden');
    document.getElementById('dispatchPlaceholder').classList.remove('hidden');
    document.getElementById('sendBackForm').reset();
}
</script>
{% endblock %}